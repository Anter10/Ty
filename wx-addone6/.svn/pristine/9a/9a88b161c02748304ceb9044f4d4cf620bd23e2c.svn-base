{"version":3,"sources":["../../../../../assets/Script/CommonFrame/assets/Script/CommonFrame/PropagateInterface.js"],"names":["tywx","PropagateInterface","ShareConfig","getShareConfigInfo","reqObj","timeStamp","Date","getTime","act","time","game_mark","SystemInfo","cloudId","gameId","signStr","getConfigSignStr","paramStrList","key","push","finalUrl","shareManagerUrl","join","successcb","ret","LOGE","JSON","stringify","retmsg","NotificationCenter","trigger","EventType","GET_SHARE_CONFIG_SUCCESS","failcb","GET_SHARE_CONFIG_FAIL","HttpUtil","httpGet","_cachedShareConfig","undefined","_pendingFlag","getShareConfigInfoAutoWeight","_shuffleByWeights","_doHttpGetShareConfig","self","fc","cc","director","Timer","setTimer","setTimeout","slotArr","length","totalWeights","reduce","x","y","weight","rnd","Math","random","i","getUserFeatureInfo","cloud_id","game_id","user_id","UserInfo","userId","GET_USER_FEATURE_SUCCESS","GET_USER_FEATURE_FAIL","sortedKeys","Object","keys","sort","finalSign","hex_md5"],"mappings":"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","file":"PropagateInterface.js","sourceRoot":"../../../../../assets/Script/CommonFrame","sourcesContent":["/**\n * Created by xiaochuntian on 2018/5/25.\n * 营销传播智能管理系统对应数据获取接口\n */\n\n\ntywx.PropagateInterface = {\n    ShareConfig: {},\n\n    /**\n     * 通过http获取分享相关信息\n     * http://market.touch4.me/?act=api.getShareConfig&time=1421755384&game_mark=richddz&sign=a30ab1292aa5929e7f913ceed795f78c\n     test demo\n     var param = {\n                 share_type:\"hyyq2\",      //获取分享点相关参数,可不传,传则代表获取单个分享点,不传表示获取all\n                 config_id:\"002003003\"    //获取方案对应数据,不论该方案是否已发布,内部测试接口参数,代码发布上线时请删除\n             };\n     tywx.PropagateInterface.getShareConfigInfo(param);\n     */\n    getShareConfigInfo: function (reqObj) {\n        if (typeof(reqObj) != 'object') {\n            reqObj = {};\n        }\n\n        var timeStamp = new Date().getTime();\n        reqObj.act = 'api.getShareConfig';\n        reqObj.time = timeStamp;\n        reqObj.game_mark = tywx.SystemInfo.cloudId + \"-\" + tywx.SystemInfo.gameId;\n\n        var signStr = this.getConfigSignStr(reqObj);\n        var paramStrList = [];\n        for (var key in reqObj) {\n            paramStrList.push(key + '=' + reqObj[key]);\n        }\n        paramStrList.push('sign=' + signStr);\n        var finalUrl = tywx.SystemInfo.shareManagerUrl + '?' + paramStrList.join('&');\n        var successcb = function (ret) {\n            tywx.LOGE(\"GET_SHARE_CONFIG_INFO_SUCCESS\", JSON.stringify(ret));\n            for (var key in ret.retmsg) {\n                tywx.PropagateInterface.ShareConfig[key] = ret.retmsg[key];\n            }\n            tywx.NotificationCenter.trigger(tywx.EventType.GET_SHARE_CONFIG_SUCCESS, ret);\n        };\n\n        var failcb = function (ret) {\n            tywx.LOGE(\"GET_SHARE_CONFIG_INFO_FAIL\", JSON.stringify(ret));\n            tywx.NotificationCenter.trigger(tywx.EventType.GET_SHARE_CONFIG_FAIL, ret);\n        };\n        tywx.HttpUtil.httpGet({'url': finalUrl}, successcb, failcb);\n    },\n\n    /**\n     * 通过http获取分享相关信息,根据权重自动选择条目,\n     * 本地有缓存,调用后会立刻返回分享信息,不会出现http请求带来的延迟\n     * http://market.touch4.me/?act=api.getShareConfig&time=1421755384&game_mark=28-20015&sign=1d356c1417a1d58fcec442eb8f655a4e\n     tywx.PropagateInterface.getShareConfigInfoAutoWeight();\n     * 返回值例子:\n      {\n\t\t    \"normalshare\": {\n                \"sharePicUrl\": \"http:\\/\\/xiaoyouxi.qiniu.andla.cn\\/pkgame\\/share_wx\\/mr_gun_share4.png\",\n                \"shareContent\": \"精彩街机射击游戏，玩出你风格\",\n                \"sharePointId\": \"024\",\n                \"shareSchemeId\": \"035032\",\n                \"extraAdd\": [],\n                \"weight\": 10\n\t\t    }\n\t  }\n     *\n     *\n     */\n    _cachedShareConfig: undefined,\n    _pendingFlag: false,\n    getShareConfigInfoAutoWeight: function () {\n        if (this._cachedShareConfig == undefined) {\n            // 还未获取到分享配置,记录当前请求,走异步接口\n            this._pendingFlag = true;\n        }\n        else {\n            // 本地已有分享配置,立即返回事件\n            tywx.NotificationCenter.trigger(tywx.EventType.GET_SHARE_CONFIG_SUCCESS, this._shuffleByWeights());\n        }\n    },\n\n    _doHttpGetShareConfig: function () {\n        var reqObj = {};\n        var timeStamp = new Date().getTime();\n        reqObj.act = 'api.getShareConfig';\n        reqObj.time = timeStamp;\n        reqObj.game_mark = tywx.SystemInfo.cloudId + \"-\" + tywx.SystemInfo.gameId;\n\n        var signStr = this.getConfigSignStr(reqObj);\n        var paramStrList = [];\n        for (var key in reqObj) {\n            paramStrList.push(key + '=' + reqObj[key]);\n        }\n        paramStrList.push('sign=' + signStr);\n        var finalUrl = tywx.SystemInfo.shareManagerUrl + '?' + paramStrList.join('&');\n\n        var self = this;\n        var successcb = function (ret) {\n            self._cachedShareConfig = ret.retmsg;\n            // tywx.LOGE(\"分享数据= \"+JSON.stringify(ret.retmsg));\n            if (self._pendingFlag) {\n                tywx.NotificationCenter.trigger(tywx.EventType.GET_SHARE_CONFIG_SUCCESS, self._shuffleByWeights());\n                self._pendingFlag = false;\n            }\n        };\n\n        var failcb = function (ret) {\n            if (self._pendingFlag) {\n                tywx.NotificationCenter.trigger(tywx.EventType.GET_SHARE_CONFIG_FAIL, ret);\n                self._pendingFlag = false;\n            }\n            var fc = function () {\n                self._doHttpGetShareConfig();\n            };\n            if(typeof(cc) != 'undefined' && cc.director) {\n                tywx.Timer.setTimer(cc.director, fc, 10, 0, 0);\n            } else {\n                setTimeout(fc, 10000);\n            }\n        };\n        tywx.HttpUtil.httpGet({'url': finalUrl}, successcb, failcb);\n    },\n\n    _shuffleByWeights: function () {\n        var ret = {};\n        for (var key in this._cachedShareConfig) {\n            if(key == 'shareExt') continue;\n            var slotArr = this._cachedShareConfig[key];\n            if (slotArr.length == 0) {\n                ret[key] = {};\n            }\n            else if (slotArr.length == 1) {\n                ret[key] = slotArr[0];\n            }\n            else {\n                var totalWeights = slotArr.reduce(function (x, y) {\n                    return x + y.weight;\n                }, 0);\n                var rnd = Math.random() * totalWeights;\n                for (var i = 0; i < slotArr.length; i++) {\n                    rnd -= slotArr[i].weight;\n                    if (rnd <= 0) {\n                        ret[key] = slotArr[i];\n                        break;\n                    }\n                }\n            }\n        }\n        return ret;\n    },\n\n    /**\n     * 获取用户特征值接口\n     * http://market.touch4.me/?act=api.getUserFeature&cloud_id=24&game_id=6&time=1527235026&user_id=1404248&sign=a2b6938904ac3759fe6404ea8ed49267\n     * @param reqObj\n     */\n    getUserFeatureInfo: function () {\n        var reqObj = {};\n        var timeStamp = new Date().getTime();\n        reqObj.act = 'api.getUserFeature';\n        reqObj.cloud_id = tywx.SystemInfo.cloudId;\n        reqObj.game_id = tywx.SystemInfo.gameId;\n        reqObj.user_id = tywx.UserInfo.userId;\n        reqObj.time = timeStamp;\n\n        var signStr = this.getConfigSignStr(reqObj);\n        var paramStrList = [];\n        for (var key in reqObj) {\n            paramStrList.push(key + '=' + reqObj[key]);\n        }\n        paramStrList.push('sign=' + signStr);\n        var finalUrl = tywx.SystemInfo.shareManagerUrl + '?' + paramStrList.join('&');\n        var successcb = function (ret) {\n            tywx.NotificationCenter.trigger(tywx.EventType.GET_USER_FEATURE_SUCCESS, ret);\n        };\n\n        var failcb = function (ret) {\n            tywx.NotificationCenter.trigger(tywx.EventType.GET_USER_FEATURE_FAIL, ret);\n        };\n        tywx.HttpUtil.httpGet({'url': finalUrl}, successcb, failcb);\n    },\n\n    /**\n     * 计算签名字符串\n     * @param reqObj\n     * @returns {string}\n     */\n    getConfigSignStr: function (reqObj) {\n        var sortedKeys = Object.keys(reqObj).sort();\n        var signStr = '';\n        for (var i = 0; i < sortedKeys.length; i++) {\n            var key = sortedKeys[i];\n            if (key == 'act' || key == 'sign') {\n                continue;\n            } else {\n                signStr += key + '=' + reqObj[key];\n            }\n        }\n        var finalSign = tywx.hex_md5('market.tuyoo.com-api-' + signStr + '-market.tuyoo-api') || '';\n        return finalSign;\n    },\n};"]}