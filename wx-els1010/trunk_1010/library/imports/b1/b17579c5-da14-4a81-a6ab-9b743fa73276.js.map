{"version":3,"sources":["../../../../../../assets/scripts/game/lottery/assets/scripts/game/lottery/lottery_view.js"],"names":["TAG","lotterygetview","require","LOCAL_STOREITEM_KEY","cc","Class","extends","Component","properties","nodeDisk","Node","lottery_item","Prefab","background","alltnode","type","default","allbtnnode","videoBtn","shareBtn","freeBtn","chouJiangCall","isLottering","lottery","onLoad","self","videoBtnScript","getComponent","setButtonCallType","setShareConfig","tywx","tt","constants","ShareConfig","HOME_ZP_GET_VIDEO","setSuccessCall","shareBtnScript","HOME_ZP_GET_SHARE","freeBtnScript","setReactCall","HOME_ZP_FREE_SHARE","start","setData","data","initUI","error","closeView","removeLotteryView","pre","ti","lotteryItem","instantiate","rotation","item_script","items","addChild","initUiButton","buttypes","button_types","buttonindex","buttontype","buttons","split","log","JSON","stringify","typebtn","btntype","tin","length","active","position","btnStartLottery","getCjType","console","RedPacketInfo","aims","czaim","hbaim","aim_id","parseInt","Math","random","nextAmount","item","current_rotate","runAction","sequence","rotateBy","easing","easeIn","easeOut","callFunc","storeCurrentItem","init","parse","Utils","loadItem","allitems","findit","itIndex","id","gift_id","num","push","titem","getAddItem","saveItem","show","requestAddRedPacket","success","res","name","fail","showWXToast","number","icon"],"mappings":"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","file":"lottery_view.js","sourceRoot":"../../../../../../assets/scripts/game/lottery","sourcesContent":[" let TAG = '[game/lottery/lottery_view.js]]';\n\n let lotterygetview = require('./lottery_get_view'); //* 大转盘管理\n let LOCAL_STOREITEM_KEY = \"tt-items\";\n cc.Class({\n     extends: cc.Component,\n     properties: {\n         nodeDisk: cc.Node,\n         lottery_item: cc.Prefab,\n         background: cc.Node,\n         alltnode: {\n             type: cc.Node,\n             default: [],\n         },\n         allbtnnode: {\n             type: cc.Node,\n             default: [],\n         },\n         videoBtn: cc.Node,\n         shareBtn: cc.Node,\n         freeBtn: cc.Node,\n     },\n\n     chouJiangCall: function () {\n         if (this.isLottering) return;\n         this.lottery();\n     },\n\n     onLoad() {\n         const self = this;\n\n         // 初始化按钮的事件\n         // 视频抽奖\n         const videoBtnScript = this.videoBtn.getComponent(\"ShareButton\")\n         videoBtnScript.setButtonCallType(2);\n         videoBtnScript.setShareConfig(tywx.tt.constants.ShareConfig.HOME_ZP_GET_VIDEO);\n         videoBtnScript.setSuccessCall(function () {\n             self.chouJiangCall();\n         });\n         // 分享抽奖\n         const shareBtnScript = this.shareBtn.getComponent(\"ShareButton\")\n         shareBtnScript.setButtonCallType(1);\n         shareBtnScript.setShareConfig(tywx.tt.constants.ShareConfig.HOME_ZP_GET_SHARE);\n         shareBtnScript.setSuccessCall(function () {\n             self.chouJiangCall();\n         });\n         // 免费抽奖\n         const freeBtnScript = this.freeBtn.getComponent(\"ShareButton\")\n         freeBtnScript.setButtonCallType(1);\n         freeBtnScript.setReactCall(true);\n         freeBtnScript.setShareConfig(tywx.tt.constants.ShareConfig.HOME_ZP_FREE_SHARE);\n         freeBtnScript.setSuccessCall(function () {\n             self.chouJiangCall();\n         });\n        //  this.freeBtn.active = true;\n     },\n\n     start() {\n\n     },\n\n     setData: function (data) {\n         if (data) {\n             this.data = data;\n             this.initUI();\n         } else {\n             tywx.tt.error(TAG, \"没有抽奖数据\");\n         }\n     },\n\n     closeView: function () {\n         tywx.tt.lottery.removeLotteryView();\n     },\n\n     initUI: function () {\n         // 初始化道具UI\n         var pre = 0;\n         for (var ti = 0; ti < 6; ti++) {\n             let lotteryItem = cc.instantiate(this.lottery_item);\n             pre = ti * 60;\n             lotteryItem.rotation = pre;\n             let item_script = lotteryItem.getComponent('lottery_item');\n             var data = this.data.items[ti];\n             item_script.setData(data);\n             this.alltnode[ti].addChild(lotteryItem);\n         }\n         // 初始化按钮UI\n         this.initUiButton();\n     },\n\n     /**\n      * @description 控制按钮的显示\n      */\n     initUiButton: function () {\n         const buttypes = this.data.button_types;\n         const buttonindex = buttypes[0];\n         const buttontype = buttypes[1][buttonindex];\n         const buttons = buttontype.split(\"_\");\n\n         tywx.tt.log(\"当前显示的buttons = \" + JSON.stringify(buttons));\n         var typebtn = [];\n         var btntype = buttons[0];\n\n         for (var tin = 0; tin < buttons.length; tin++) {\n             if (buttons[tin] == \"share\") {\n                 typebtn[tin] = this.shareBtn;\n                 this.shareBtn.active = true;\n             } else if (buttons[tin] == \"video\") {\n                 typebtn[tin] = this.videoBtn;\n                 this.videoBtn.active = true;\n             } else if (buttons[tin] == \"free\") {\n                 typebtn[tin] = this.freeBtn;\n                 this.freeBtn.active = true;\n             }\n         }\n         if (typebtn.length == 1) {\n             typebtn[0].position = this.allbtnnode[1];\n         }\n         if (typebtn.length == 2) {\n             typebtn[0].position = this.allbtnnode[0];\n             typebtn[1].position = this.allbtnnode[2];\n         }\n\n\n\n     },\n\n     // update (dt) {},\n     btnStartLottery() {\n         if (this.isLottering) return;\n         this.lottery();\n     },\n\n     // 确定当前抽到的是红包还是道具\n     getCjType:function(){\n        \n     },\n\n\n     lottery() {\n         console.log(\"当前的红包数据 = \" + JSON.stringify(tywx.tt.RedPacketInfo));\n         let aims = [0, 1, 2, 3, 4, 5];\n         let czaim = [1,3,5];\n         let hbaim = [0, 1, 2];\n         let aim_id = czaim[parseInt(Math.random() * czaim.length)];\n         if (tywx.tt.RedPacketInfo && tywx.tt.RedPacketInfo.nextAmount > 0) {\n             aim_id = hbaim[parseInt(Math.random() * hbaim.length)];\n         }\n\n         this.item = this.data.items[aim_id];\n         let self = this;\n         let current_rotate = this.nodeDisk.rotation % 360;\n         //let last_aim_id = parseInt(current_rotate / 60);\n         this.isLottering = true;\n         this.nodeDisk.runAction(\n             cc.sequence(\n                 cc.rotateBy(1, 360 * 2 - current_rotate).easing(cc.easeIn(2.0)),\n                 cc.rotateBy(2, 360 * 3),\n                 cc.rotateBy(1, 360 * 2 - aim_id * 60).easing(cc.easeOut(1.0)),\n                 cc.callFunc(() => {\n                     self.storeCurrentItem();\n                     self.isLottering = false;\n                 })\n             )\n         );\n     },\n\n     init() {\n         //  this.aim_id = 0;\n         //  for (let i = 0; i < 6; ++i) {\n         //      let lable_name = `label_${i}`;\n         //      let label_node = this.nodeLabelRoot.getChildByName(lable_name);\n         //      if (label_node) {\n         //          label_node.getComponent(cc.Label).string = `礼物${i}`;\n         //      }\n         //  }\n     },\n\n     /**\n      * @description 存储当前的转到的道具\n      */\n     storeCurrentItem: function () {\n         var items = JSON.parse(tywx.tt.Utils.loadItem(LOCAL_STOREITEM_KEY, \"[]\"));\n         var allitems = [];\n         if (items.length > 0) {\n             var findit = false;\n             for (var itIndex = 0; itIndex < items.length; itIndex++) {\n                 const item = items[itIndex];\n                 if (item.id == this.item.gift_id) {\n                     findit = true;\n                     item.num = item.num + 1;\n                 }\n                 allitems.push(item);\n             }\n             if (!findit) {\n                 const titem = this.getAddItem();\n                 allitems[allitems.length] = titem;\n             }\n         } else {\n             var titem = this.getAddItem();\n             allitems[0] = titem;\n         }\n         tywx.tt.Utils.saveItem(LOCAL_STOREITEM_KEY, JSON.stringify(allitems), false);\n         \n         const self = this;\n         if (this.item.gift_id == 2 || this.item.gift_id == 4 || this.item.gift_id == 6 ) {\n             lotterygetview.show(this.item);\n         } else {\n             tywx.tt.Utils.requestAddRedPacket({\n                 success: function (res) {\n                    //  console.log(\"qing求数据 = \" + JSON.stringify(res));\n                     self.item.name = res+\"元\";\n                     lotterygetview.show(self.item)\n                 },\n                 fail: function () {\n                     tywx.tt.Utils.showWXToast(\"请求失败\");\n                 }\n             });\n         }\n\n         tywx.tt.log(\"当前所转到的道具数据  = \" + JSON.stringify(allitems));\n     },\n\n     getAddItem: function () {\n         var titem = {};\n         titem.id = this.item.gift_id;\n         titem.num = this.item.number || 1;\n         titem.name = this.item.name;\n         titem.icon = this.item.icon;\n         return titem;\n     }\n     \n   \n\n\n\n\n });"]}