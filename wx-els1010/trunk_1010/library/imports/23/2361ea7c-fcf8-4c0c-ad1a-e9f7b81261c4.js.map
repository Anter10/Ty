{"version":3,"sources":["../../../../../assets/scripts/common_frame/assets/scripts/common_frame/TCPClient.js"],"names":["tywx","TCPClient","TAG","CONNECT_STATUS_OK","CONNECT_STATUS_OPENING","CONNECT_STATUS_CLOSING","CONNECT_STATUS_FAIL","connectStatus","isTimerInited","tickCount","filterCmds","timerSchedule","NotificationCenter","trigger","EventType","SEND_HEART_BEAT","reconnet","startCheckTimer","setInterval","stopCheckTimer","clearInterval","connect","url","BiLog","clickStat","clickStatEventType","clickStatEventTypeTCPStart","IsWechatPlatform","doWechatConnect","wx","connectSocket","onSocketOpen","res","LOGD","TCP_OPENED","clickStatEventTypeTCPSuccess","onSocketError","clickStatEventTypeTCPFailed","TCP_ERROR","onSocketClose","TCP_CLOSE","onSocketMessage","StateInfo","isOnForeground","content","decodeMessage","msgStr","unescape","replace","strJson","substr","length","_json","JSON","parse","indexOf","cmd","TCP_RECEIVE","err","LOGE","stringify","data","ArrayBuffer","databytes","Uint8Array","i","len","tmpc","String","fromCharCode","EncodeDecode","base64Decode","mask","slice","charcode","result","utf8Decode","TCP_RECONNECT","SystemInfo","webSocketUrl","sendMsg","sendSocketMessage","success","params","fail","errMsg","closeSocket","arguments","complete","close"],"mappings":"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","file":"TCPClient.js","sourceRoot":"../../../../../assets/scripts/common_frame","sourcesContent":["/**\n * 微信小程序下TCP长连接使用websocket实现\n */\n\ntywx.TCPClient = {\n    TAG : \"TCP client\",\n    CONNECT_STATUS_OK : 1,\n    CONNECT_STATUS_OPENING : 2,\n    CONNECT_STATUS_CLOSING : 3,\n    CONNECT_STATUS_FAIL : 0,\n    connectStatus : 0,\n    isTimerInited : false,\n    tickCount : 0,\n    filterCmds : ['heart_beat'],\n\n    /**\n     * 该方法包含了心跳和tcp状态检查两项功能,结合connect中的逻辑,是一个无限重试的机制\n     */\n    timerSchedule : function() {\n        tywx.TCPClient.tickCount = (tywx.TCPClient.tickCount + 1) % 3;\n        if (tywx.TCPClient.tickCount == 2 && tywx.TCPClient.connectStatus == tywx.TCPClient.CONNECT_STATUS_OK) {\n            //每3秒发送心跳\n            //hall.MsgFactory.sendHeartBeat();\n            //监听者进行具体的协议实现\n            tywx.NotificationCenter.trigger(tywx.EventType.SEND_HEART_BEAT);\n        }\n\n        // 每1秒检查一下长连接，如果不通，则重连。\n        tywx.TCPClient.reconnet();\n    },\n\n    startCheckTimer: function() {\n        tywx.TCPClient.isTimerInited = true;\n        setInterval(this.timerSchedule, 1*1000);\n    },\n\n    stopCheckTimer: function() {\n        tywx.TCPClient.isTimerInited = false;\n        clearInterval(this.timerSchedule);\n    },\n\n    //以下为websocket连接相关方法\n    connect: function(url){\n        tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeTCPStart, [url]);\n        if (tywx.TCPClient.connectStatus == tywx.TCPClient.CONNECT_STATUS_OPENING\n            || tywx.TCPClient.connectStatus == tywx.TCPClient.CONNECT_STATUS_OK) {\n            return;\n        }\n\n        tywx.TCPClient.connectStatus = tywx.TCPClient.CONNECT_STATUS_OPENING;\n        if(tywx.IsWechatPlatform()) {\n            this.doWechatConnect(url);\n        }\n    },\n\n    doWechatConnect: function(url) {\n        try{\n            if(!tywx.IsWechatPlatform()) {\n                return;\n            }\n            wx.connectSocket({\n                url: url\n            });\n\n            wx.onSocketOpen(function(res) {\n                tywx.LOGD(tywx.TCPClient.TAG, 'TCP webSocket opened...');\n                tywx.TCPClient.connectStatus = tywx.TCPClient.CONNECT_STATUS_OK;\n\n                tywx.NotificationCenter.trigger(tywx.EventType.TCP_OPENED);\n                tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeTCPSuccess, [url]);\n                if (!tywx.TCPClient.isTimerInited) {\n                    //启动TCP的定时检查机制,成功连接1次后将永久进行检查\n                    tywx.TCPClient.startCheckTimer();\n                }\n            });\n\n            wx.onSocketError(function(res) {\n                tywx.LOGD(tywx.TCPClient.TAG, 'TCP webSocket error...');\n                tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeTCPFailed, [url]);\n\n                tywx.TCPClient.connectStatus = tywx.TCPClient.CONNECT_STATUS_FAIL;\n                tywx.NotificationCenter.trigger(tywx.EventType.TCP_ERROR);\n            });\n\n\n            wx.onSocketClose(function(res) {\n                tywx.LOGD(tywx.TCPClient.TAG, 'WebSocket 已关闭！');\n                tywx.TCPClient.connectStatus = tywx.TCPClient.CONNECT_STATUS_FAIL;\n                tywx.NotificationCenter.trigger(tywx.EventType.TCP_CLOSE);\n            });\n\n            wx.onSocketMessage(function(res) {\n                if (!tywx.StateInfo.isOnForeground){\n                    //在后台不处理消息\n                    return;\n                }\n                // 处理长连接的消息\n                var content = tywx.TCPClient.decodeMessage(res[\"data\"]);\n                if (content == null || content == '0000') {\n                    return;\n                }\n\n                var msgStr = \"[Receive TCP Msg]: \" + unescape(content.replace(/\\\\u/gi,'%u'));\n                var strJson = content.substr(0, content.length - 0);\n                if (strJson != null && strJson.length > 0) {\n                    var _json = JSON.parse(strJson);\n                    if (tywx.TCPClient.filterCmds.indexOf(_json.cmd) == -1){\n                        tywx.LOGD(tywx.TCPClient.TAG, msgStr);\n                    }\n\n                    tywx.NotificationCenter.trigger(tywx.EventType.TCP_RECEIVE, _json);\n                }\n\n            });\n        }\n        catch(err) {\n            tywx.LOGE(\"error:\", \"tywx.TCPClient.doWechatConnect——\" + JSON.stringify(err));\n        }\n    },\n\n    decodeMessage: function(data) {\n        if (typeof ArrayBuffer != 'undefined' && data instanceof ArrayBuffer) {\n            var databytes = new Uint8Array(data);\n            var content = ''\n            for (var i = 0, len = databytes.length; i < len; i++) {\n                var tmpc = String.fromCharCode(databytes[i]);\n                content += tmpc;\n            }\n            return content;\n        }\n        var data = tywx.EncodeDecode.base64Decode(data);\n        var mask = data.slice(0, 4);\n        data = data.slice(4);\n        for (var i = 0, len = data.length; i < len; i++) {\n            var charcode = data[i];\n            charcode ^= mask[i % 4];\n            data[i] = charcode;\n        }\n        var result = tywx.EncodeDecode.utf8Decode(data);\n        return result;\n    },\n\n    reconnet:function () {\n        if (!tywx.StateInfo.isOnForeground){\n            //在后台不重连(IOS会出问题)\n            return;\n        }\n        if (tywx.TCPClient.connectStatus == tywx.TCPClient.CONNECT_STATUS_FAIL) {\n            tywx.NotificationCenter.trigger(tywx.EventType.TCP_RECONNECT);\n            tywx.TCPClient.connect(tywx.SystemInfo.webSocketUrl);\n        }\n    },\n\n    sendMsg: function(data) {\n        try {\n            if (tywx.TCPClient.connectStatus != tywx.TCPClient.CONNECT_STATUS_OK) {\n                return;\n            }\n\n            var msgStr = JSON.stringify(data);\n            if (tywx.TCPClient.filterCmds.indexOf(data.cmd) == -1){\n                tywx.LOGD(tywx.TCPClient.TAG, 'TCP sendMsg:' + msgStr);\n            }\n\n            if(tywx.IsWechatPlatform()) {\n                wx.sendSocketMessage({\n                    data:msgStr,\n                    success: function(params){\n                        tywx.LOGD(tywx.TCPClient.TAG, 'TCP sendMsg success:' + JSON.stringify(params));\n                    },\n\n                    fail: function(params) {\n                        var errMsg = params[0];\n                        if (errMsg && errMsg['errMsg'] === 'sendSocketMessage:fail taskID not exist'){\n                            wx.closeSocket();\n                            tywx.TCPClient.connectStatus = tywx.TCPClient.CONNECT_STATUS_FAIL;\n                        }\n                        tywx.LOGD(tywx.TCPClient.TAG, 'TCP sendMsg fail:' + JSON.stringify(arguments));\n                    },\n\n                    complete: function(params) {\n                    }\n                });\n            }\n        }\n        catch(err) {\n            tywx.LOGE(\"error:\", \"tywx.TCPClient.sendMsg——\" + JSON.stringify(err));\n        }\n    },\n\n    close: function(){\n        try {\n            tywx.TCPClient.connectStatus = tywx.TCPClient.CONNECT_STATUS_CLOSING;\n            if(tywx.IsWechatPlatform()) {\n                wx.closeSocket();\n            }\n            tywx.TCPClient.stopCheckTimer();\n            tywx.LOGD(tywx.TCPClient.TAG, 'TCP close..............');\n        }\n        catch(err) {\n            tywx.LOGE(\"error:\", \"tywx.TCPClient.close——\" + JSON.stringify(err));\n        }\n    }\n};\n"]}