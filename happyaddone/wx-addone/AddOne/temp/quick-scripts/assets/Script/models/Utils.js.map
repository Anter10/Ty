{"version":3,"sources":["Utils.js"],"names":["crypto","require","Utils","key","cc","sys","localStorage","removeItem","tywx","isInWXChat","wx","removeUserCloudStorage","keyList","success","msg","console","log","fail","value","only_local","setItem","setUserCloudStorage","KVDataList","default_value","v","getItem","tag","result","success_cb","fail_cb","shareTickets","call_succ","call_fail","ff","getShareInfo","shareTicket","res","iv","encryptedData","resultStr","decrypt","UserInfo","wxgame_session_key","resultObj","JSON","parse","id","openGId","t0","parseInt","loadItem","tc","Date","getTime","saveItem","e","share_tag","config","tmp_arr","PropagateInterface","ShareConfig","hasOwnProperty","rand_idx","Math","random","length","crypted","decoded","Buffer","decipher","createDecipheriv","setAutoPadding","update","final","err","duration","showToast","title","icon","error","content","show_cancel","sure_cb","cancle_cb","showModal","showCancel","confirm","cancel","module","exports"],"mappings":"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","file":"Utils.js","sourceRoot":"../../../../../assets/Script/models","sourcesContent":["let crypto = require('crypto');\nlet Utils = class{\n    /**\n     * * 删除存储在本地的指定数据\n     *\n     * @static\n     * @param {String} key 标识\n     * @returns\n     */\n    static delItem(key) {\n        cc.sys.localStorage.removeItem(key);\n        if (!tywx.isInWXChat)\n            return;\n        wx.removeUserCloudStorage({\n            keyList: [key],\n            success: (msg) => { console.log('removeObjectCloud  ' + key + ' succeeds', msg); },\n            fail: (msg) => { console.log('removeObjectCloud  ' + key + ' fails', msg); },\n        });\n    }\n\n    /**\n     * * 保存数据到本地\n     *\n     * @static\n     * @param {String} key 标识\n     * @param {any} value\n     * @param {boolean} only_local 是否只保存在本地,false的情况，上传到腾讯云\n     * @returns\n     */\n    static saveItem (key, value, only_local) {\n        value = value + '';\n        cc.sys.localStorage.setItem(key, value);\n        if (!tywx.isInWXChat)\n            return;\n        if (!only_local) {\n            //FIXED: 做版本检测，版本低的会有黑屏\n            if(wx.setUserCloudStorage){\n                wx.setUserCloudStorage({\n                    KVDataList: [{ key: key, value: value }],\n                    success: (msg) => { console.log('saveObjectToCloud  ' + key + ' succeeds', msg); },\n                    fail: (msg) => { console.log('saveObjectToCloud  ' + key + ' fails', msg); },\n                });\n            }\n        }\n    }\n    /**\n     * * 加载保存在本地的数据\n     *\n     * @static\n     * @param {String} key 标识\n     * @param {any} default_value 默认值\n     * @returns\n     */\n    static loadItem (key, default_value) {\n            var v = cc.sys.localStorage.getItem(key);\n            // console.log(key, 'v'+v);\n            if (!v) {\n                cc.sys.localStorage.setItem(key, default_value);\n                return default_value;\n            }\n            return v;\n    }\n    /**\n     * @description 分享到不同群限制\n     * @author lu ning\n     * @date 2018-08-22\n     * @static\n     * @param {String} tag 分享tag\n     * @param {Object} result 分享返回值\n     * @param {Function} success_cb 成功回调\n     * @param {Function} fail_cb 失败回调\n     * @returns\n     */\n    static share2GroupByTicket(tag, result, success_cb, fail_cb){\n        if (!result.shareTickets || !result.shareTickets[0]) return false;\n        let call_succ = () => {\n            if (success_cb) success_cb();\n        };\n        let call_fail = () => {\n            if (fail_cb) fail_cb();\n        };\n        let ff = Utils;\n\n        wx.getShareInfo({\n            shareTicket: result.shareTickets[0],\n            success: (res) => {\n                console.log('isCanShare2GroupByTicket==>', res);\n                try {\n                    let iv = res.iv;\n                    let encryptedData = res.encryptedData;\n                    let resultStr = ff.decrypt(tywx.UserInfo.wxgame_session_key, iv, encryptedData);\n                    console.log('resultStr==>', resultStr);\n                    if (resultStr && resultStr !== 0) {\n                        let resultObj = JSON.parse(resultStr);\n                        let id = `${tag}_${resultObj.openGId}`;\n                        let t0 = parseInt(ff.loadItem(id, 0));\n                        let tc = new Date().getTime();\n                        console.log('isCanShare2GroupByTicket==>openGId', id, typeof id);\n                        if (tc - t0 >= 8 * 60 * 60 * 1000) {\n                            ff.saveItem(id, tc, true);\n                            call_succ();\n                        } else {\n                            call_fail();\n                        }\n                    }else {\n                        call_fail();\n                    }\n\n                } catch (e) {\n                    console.log(\"share::\" , e);\n                    call_fail();\n                }\n            },\n            fail: () => {\n                call_fail();\n            }\n        });\n    }\n\n    /**\n     * @description 获取随机分享数据\n     * @author lu ning\n     * @date 2018-08-23\n     * @static\n     * @param {String} share_tag\n     */\n    static getRandomShareConfigByShareTag(share_tag){\n        let config = null;\n        let tmp_arr = [];\n        if(tywx.PropagateInterface.ShareConfig.hasOwnProperty(share_tag)){\n            tmp_arr = tywx.PropagateInterface.ShareConfig[share_tag];\n            let rand_idx = parseInt(Math.random() * tmp_arr.length);\n            config = tmp_arr[rand_idx];\n        }\n        return config;\n    }\n\n    static decrypt(key, iv, crypted) {\n        var decoded = 0;\n        try {\n            crypted = new Buffer(crypted, 'base64');\n            iv = new Buffer(iv, 'base64');\n            key = new Buffer(key, 'base64');\n\n            var decipher = crypto.createDecipheriv('aes-128-cbc', key, iv);\n            decipher.setAutoPadding(true);\n\n            decoded = decipher.update(crypted, 'binary', 'utf8');\n            decoded += decipher.final('utf8');\n        } catch (err) {\n            console.log(\"decrypt\", \" catch error: \" + err);\n        }\n        return decoded;\n    }\n\n    /**\n     * @description \n     * @author lu ning\n     * @date 2018-08-24\n     * @static\n     * @param {String} msg\n     * @param {number} [duration=1000]\n     */\n    static showWXToast(msg, duration = 1000){\n        if(wx.showToast){\n            wx.showToast({\n                title: msg,\n                icon: '',\n                duration: duration\n            });\n        }\n        else{\n            cc.error('showWXToast error can not find function wx.showToast');\n        }\n    }\n    /**\n     * @description 显示模态窗\n     * @author lu ning\n     * @date 2018-08-24\n     * @static\n     * @param {String} content 显示内容\n     * @param {String} [title='提示'] title\n     * @param {boolean} [show_cancle=false]  是否显示取消\n     * @param {Function} [sure_cb=null] 确定按钮回调\n     * @param {Function} [cancle_cb=null] 取消按钮回调\n     */\n    static showWXModal(content, title = '提示', show_cancel = false, sure_cb = null, cancle_cb = null){\n        wx.showModal({\n            title: title,\n            content: content,\n            showCancel: show_cancel,\n            success: function(res) {\n              if (res.confirm) {\n                console.log('用户点击确定');\n                sure_cb && sure_cb();\n              } else if (res.cancel) {\n                console.log('用户点击取消');\n                cancle_cb && cancle_cb();\n              }\n            }\n        });\n    }\n};\n\nmodule.exports = Utils;"]}