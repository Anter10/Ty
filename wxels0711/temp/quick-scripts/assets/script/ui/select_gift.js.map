{"version":3,"sources":["select_gift.js"],"names":["ELSEvent","require","els","cc","Class","extends","Component","properties","no_gift_tips","Sprite","gift_item","Prefab","onLoad","showWithData","tywx","StoreList","gs","node","active","NotificationCenter","listen","ELS_EVENT_SELECT_GIFT","updateUI","ELS_EVENT_CLEARN_MALL","init","showData","data","self","items","index","item","length","undefined","c","instantiate","x","y","parseInt","position","v2","getComponent","push","parent","para","showMall","select_para","price","priceDiamond","UserInfo","diamond","forEach","select","trigger","ELS_EVENT_CLEARN_GIFT_PROP_ANIMATION","select_gift_item","Util","wechatShowModal","params","confirm","console","log","ELS_EVENT_SHOW_GIFT_PROP_ANIMATION","type","prop_id","productId","substr","updateSelect","loader","loadRes","err","prefab","preFabNode","UIManager","getCurrentUI","curIndex","hidden_tips","back_btn_click","destroyAllChildren","removeAllChildren","destroy","onDestroy","ignoreScope","share_btn_click","home_node","getUI","ELS_GAME_LAYER","HOMEPAGE","make_share","_imageUrl","inviteName","userName","avatarUrl","userPic","openId","wx","showToast","title","duration","TuyooSDK","login","plaintext","ciphertext","_uuid","createUUID","_query","userId","ELS_SHRAE_TYPE","GAME_QQH_MAKE","uuid","_item","content","itemId","_amount","ShareInterface","shareMsg","imageUrl","query","successCallback","_","BiLog","clickStat","clickStatEventType","clickStatEventTypeSendQQH","TCPClient","connectStatus","CONNECT_STATUS_OK","MSG","whisperStart","failCallback"],"mappings":"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","file":"select_gift.js","sourceRoot":"../../../../../assets/script/ui","sourcesContent":["var ELSEvent = require(\"../core/ElsEvents.js\");\nvar els = require(\"../core/els.js\");\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        no_gift_tips: cc.Sprite,\n        gift_item: cc.Prefab\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad() {\n        this.showWithData(tywx.StoreList.gs);\n        this.no_gift_tips.node.active = true;\n        // 监听点击事件 刷新\n        tywx.NotificationCenter.listen(ELSEvent.ELS_EVENT_SELECT_GIFT, this.updateUI, this);\n        tywx.NotificationCenter.listen(ELSEvent.ELS_EVENT_CLEARN_MALL, this.updateUI, this);\n    },\n\n    init(showData) {\n        this.showData = showData;\n    },\n\n    showWithData(data) {\n        this.data = data;\n        let self = this;\n        this.items = [];\n        for (let index = 0; index < 9; index++) {\n            let item = self.data.length > index ? self.data[index] : undefined;\n            let c = cc.instantiate(self.gift_item);\n            let x = (index % 3 - 1) * 177;\n            let y = parseInt(index / 3) < 1 ? 413.5 : 65.5;\n            if (parseInt(index / 3) === 1) {\n                y = 239.5;\n            }\n            c.position = cc.v2(x, y);\n            c.getComponent(\"select_gift_item\").init(item, index);\n            self.items.push(c);\n            c.parent = self.node;\n        };\n    },\n\n    updateUI(para) {\n        // 刷新界面 \n        let self = this;\n        let showMall = true;\n\n        if (!para && this.select_para) {\n            let price = parseInt(this.select_para.item.priceDiamond);\n            if (price > tywx.UserInfo.diamond) {\n                return;\n            }\n            para = this.select_para;\n        }\n        if (!this.items) return;\n        this.select_para = para;\n        this.items.forEach((item, index) => {\n            if (index === para.index) {\n                if (para.select) { // 反选\n                    // 取消播放动画 \n                    tywx.NotificationCenter.trigger(ELSEvent.ELS_EVENT_CLEARN_GIFT_PROP_ANIMATION);\n                    // 展示tips\n                    self.no_gift_tips.node.active = true;\n                    // 移除选中礼物\n                    tywx.UserInfo.select_gift_item = undefined;\n                } else { // 选择礼物\n                    tywx.NotificationCenter.trigger(ELSEvent.ELS_EVENT_CLEARN_GIFT_PROP_ANIMATION);\n                    let price = parseInt(para.item.priceDiamond);\n                    if (price > tywx.UserInfo.diamond) {\n                        tywx.Util.wechatShowModal(\"钻石不够啦,去购买?\", false, \"确定\",\n                            function(params) { // \n                                if (params.confirm) {\n                                    console.log(\"to invalid\");\n                                    self.showMall();\n                                    // self.no_gift_tips.node.active = true;\n                                } else {\n                                    console.log(\"to cancel\");\n                                }\n                            }\n                        );\n                        // this.showMall();\n                        self.no_gift_tips.node.active = true;\n                        return;\n                    } else { // 拥有的钻石够\n                        // 隐藏tips\n                        self.no_gift_tips.node.active = false;\n                        // 切换动画\n                        tywx.NotificationCenter.trigger(ELSEvent.ELS_EVENT_SHOW_GIFT_PROP_ANIMATION, {\n                            type: 1,\n                            prop_id: 1000 + parseInt(para.item.productId.substr(-3))\n                        });\n                        // 添加选中礼物\n                        tywx.UserInfo.select_gift_item = para.item;\n                    }\n                }\n                item.getComponent(\"select_gift_item\").updateSelect(!para.select);\n            } else {\n                item.getComponent(\"select_gift_item\").updateSelect(false);\n            }\n        });\n    },\n\n    showMall() {\n        let self = this;\n        cc.loader.loadRes('prefab/mall/mall', function(err, prefab) {\n            var preFabNode = cc.instantiate(prefab);\n            preFabNode.parent = tywx.UIManager.getCurrentUI();\n            preFabNode.getComponent(\"mall\").curIndex = 2;\n        });\n    },\n\n    hidden_tips() {\n        this.no_gift_tips.node.active = false;\n    },\n\n    back_btn_click() {\n        this.node.active = false;\n        this.node.destroyAllChildren();\n        this.node.removeAllChildren();\n        this.node.destroy();\n    },\n\n    onDestroy() {\n        tywx.NotificationCenter.trigger(ELSEvent.ELS_EVENT_CLEARN_GIFT_PROP_ANIMATION);\n        tywx.NotificationCenter.ignoreScope(this);\n    },\n\n    share_btn_click() {\n        //TODO: 分享\n        console.log(\"chenxi::\", \"share_btn_click\", this.showData);\n        var home_node = tywx.UIManager.getUI(els.ELS_GAME_LAYER.HOMEPAGE);\n        home_node.node.getComponent(\"homePage\").make_share.active = true;\n        this.back_btn_click();\n        return;\n\n        let _imageUrl = this.showData['imgUrl'];\n        let inviteName = tywx.UserInfo.userName;\n        let avatarUrl = tywx.UserInfo.userPic;\n        let openId = tywx.UserInfo.openId;\n        if (!openId) {\n            wx.showToast({\n                title: '请先登录~',\n                duration: 1000,\n            });\n            tywx.TuyooSDK.login();\n            return;\n        }\n        let plaintext = this.showData[\"plainText\"];\n        let ciphertext = this.showData[\"cipherText\"];\n        let _uuid = tywx.Util.createUUID();\n        let _query = \"inviteCode=\" + tywx.UserInfo.userId + \"&openId=\" + openId + \"&sourceCode=\" + els.ELS_SHRAE_TYPE.GAME_QQH_MAKE + \"&plaintext=\" + plaintext + \"&ciphertext=\" + ciphertext + \"&inviteName=\" + inviteName + \"&avatarUrl=\" + avatarUrl + \"&randomKey=\" + _uuid;\n        console.log(\"share::uuid::\", _uuid);\n        if (tywx.UserInfo.select_gift_item) {\n            tywx.UserInfo.select_gift_item.uuid = _uuid;\n        }\n        let _item = tywx.UserInfo.select_gift_item ? tywx.UserInfo.select_gift_item.content.items[0].itemId.substr(-4) : \"\";\n        let _amount = 1;\n\n        let self = this;\n        tywx.ShareInterface.shareMsg({\n            type: els.ELS_SHRAE_TYPE.GAME_QQH_MAKE,\n            imageUrl: _imageUrl,\n            query: _query,\n            successCallback: function(_) {\n                // TODO: 分享成功 \n                tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeSendQQH);\n\n                if (!tywx.UserInfo.select_gift_item || tywx.TCPClient.connectStatus != tywx.TCPClient.CONNECT_STATUS_OK) {\n                    self.back_btn_click();\n                    return;\n                }\n                tywx.MSG.whisperStart(_uuid, _item, _amount);\n                tywx.UserInfo.select_gift_item = undefined;\n                self.back_btn_click();\n            },\n            failCallback: function() {\n                console.log(\"分享失败\");\n                wx.showToast({\n                    title: '分享失败啦',\n                    duration: 1000,\n                });\n            }\n        });\n    },\n\n\n    // update (dt) {},\n});"]}