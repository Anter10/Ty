{"version":3,"sources":["tywx_wechat.js"],"names":["metaclass","cc","_Class","extend","purchase","prodId","prodPrice","prodName","prodCount","CC_WECHATGAME","console","log","sys","os","OS_IOS","inputInfo","wx","request","url","tywx","SystemInfo","loginUrl","header","data","userId","UserInfo","appId","wxAppId","clientId","imei","uuid","Util","getLocalUUID","chargeType","gameId","appInfo","mustcharge","method","success","params","JSON","stringify","results","result","code","chargeInfo","chargeData","requestMidasPayment","mode","env","offerId","buyQuantity","chargeTotal","platform","currencyType","zoneId","ty","WeChat","_pushPayment","notifyUrl","replace","orderId","platformOrderId","fail","GameData","payType","mPaymentOrderList","push","mPaymentUrl","Storage","setItem","Key_Payment_Notify_Url","Key_Payment_Notify_Order_List","join","notifyPaymentOnce","length","onPurchase","Output","warn","complete","_popPayment","i","splice","TYPay"],"mappings":"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","file":"tywx_wechat.js","sourceRoot":"../../../../../assets/script/core","sourcesContent":["/**\n *  支付相关\n *\n * */\n\nlet metaclass = cc._Class.extend({\n\n    purchase : function(prodId, prodPrice, prodName, prodCount) {\n        if (!CC_WECHATGAME) {\n            console.log( '微信虚拟支付暂不支持IOS平台1');\n            return;\n        }\n\n        if (cc.sys.os === cc.sys.OS_IOS) {\n            console.log( '微信虚拟支付暂不支持IOS平台2');\n            return;\n        }\n        let inputInfo = `prodId=${prodId} prodPrice=${prodPrice} prodName=${prodName} prodCount=${prodCount}`;\n        console.log('===[develop]===', inputInfo);\n        wx.request({\n            url     : tywx.SystemInfo.loginUrl + 'open/v5/pay/order',\n            header  : {\n                'content-type': 'application/x-www-form-urlencoded'\n            },\n            data    : {\n                userId      : tywx.UserInfo.userId,\n                appId       : tywx.SystemInfo.appId,\n                wxAppId     : tywx.SystemInfo.wxAppId,\n                clientId    : tywx.SystemInfo.clientId,\n                imei        : 'null',\n                uuid        : tywx.Util.getLocalUUID(),\n\n                prodId      : prodId,\n                prodName    : prodName,\n                prodCount   : prodCount || 1,\n                prodPrice   : prodPrice,\n                chargeType  : \"wxapp.iap\",\n                gameId      : tywx.SystemInfo.gameId,\n                appInfo     : '',\n                mustcharge  : 1,\n            },\n            method  : 'POST',\n            success : function(params) {\n                console.log('===[develop]===', 'request pay-sdk | callback | ' + JSON.stringify(params));\n\n                var results = params.data.result;\n                if (results && results.code == 0) {\n                    console.log('===[develop]===', 'request pay-sdk | success');\n\n                    var chargeInfo = results.chargeInfo;\n                    var chargeData = chargeInfo.chargeData;\n\n                    wx.requestMidasPayment({\n                        mode        : chargeData.mode,\n                        env         : chargeData.env,\n                        offerId     : chargeData.offerId,\n                        buyQuantity : 10 * chargeInfo.chargeTotal,\n                        platform    : chargeData.platform,\n                        currencyType: \"CNY\",\n                        zoneId      : chargeData.zoneId,\n                        success     : function(params) {\n                            console.log('===[develop]===', 'requestMidasPayment | success | ' + JSON.stringify(params));\n\n                            ty.WeChat._pushPayment({\n                                url     : chargeData.notifyUrl.replace(\"ve\", \"vg\"),\n                                orderId : chargeData.platformOrderId\n                            });\n                        },\n                        fail        : function(params) {\n                            console.log('===[develop]===', inputInfo, 'requestMidasPayment | failed | [2] |' + JSON.stringify(params));\n                            // 取消订单\n                            wx.request({\n                                url: ty.GameData.url + 'open/v4/pay/cancelorder',\n                                header: {\n                                    'content-type': 'application/x-www-form-urlencoded'\n                                },\n                                data: {\n                                    platformOrderId: chargeData.platformOrderId,\n                                    appId: ty.GameData.appId,\n                                    wxAppId: ty.GameData.wxAppId,\n                                    userId: ty.UserInfo.userId,\n                                    clientId: ty.GameData.clientId,\n                                    payType: \"wxapp.iap\"\n                                },\n                                method: 'POST',\n                                success: function(params) {\n                                    console.log('===[cancelorder]===', 'request : ' + JSON.stringify(params));\n                                },\n                                fail    : function(params) {\n                                    console.log('===[cancelorder]===', 'request failed :' + JSON.stringify(params));\n                                },\n                            });\n                        },\n                    });\n                } else {\n                    console.log('===[develop]===', inputInfo, 'request pay-sdk | failed | [0] |' + JSON.stringify(params));\n                }\n            },\n            fail    : function(params) {\n                console.log('===[develop]===', inputInfo, 'request pay-sdk | failed | [1] |' + JSON.stringify(params));\n            },\n        });\n    },\n\n    _pushPayment : function(params) {\n        this.mPaymentOrderList.push(params.orderId);\n        this.mPaymentUrl = params.url;\n\n        ty.Storage.setItem(ty.Storage.Key_Payment_Notify_Url, params.url);\n        ty.Storage.setItem(ty.Storage.Key_Payment_Notify_Order_List, this.mPaymentOrderList.join('|'));\n\n        this.notifyPaymentOnce();\n    },\n\n    notifyPaymentOnce : function() {\n        if (this.mPaymentUrl && this.mPaymentUrl != '' && this.mPaymentOrderList.length > 0) {\n            this.onPurchase(this.mPaymentUrl, this.mPaymentOrderList[0]);\n        }\n    },\n\n    onPurchase : function(notifyUrl, platformOrderId) {\n        console.log('===[onPurchase]===', `notifyUrl=${notifyUrl} platformOrderId=${platformOrderId}`);\n\n        wx.request({\n            url     : notifyUrl,\n            header  : {\n                'content-type': 'application/x-www-form-urlencoded'\n            },\n            data    : {\n                userId  : ty.UserInfo.userId,\n                appId   : ty.GameData.appId,\n                wxAppId : ty.GameData.wxAppId,\n                clientId: ty.GameData.clientId,\n                imei    : 'null',\n                uuid    : ty.GameData.uuid,\n                platformOrderId : platformOrderId,\n            },\n            method  : 'POST',\n            success : function(params) {\n                console.log('===[develop]===', 'notify | success | ' + JSON.stringify(params));\n            },\n            fail    : function(params) {\n                ty.Output.warn('===[develop]===', 'notify | failed | ' + JSON.stringify(params));\n            },\n            complete: function() {\n                console.log('===[develop]===', 'notify | complete');\n                ty.WeChat._popPayment(platformOrderId);\n            },\n        });\n    },\n\n    _popPayment : function(platformOrderId) {\n        for (var i = 0; i < this.mPaymentOrderList.length; i++) {\n            var orderId = this.mPaymentOrderList[i];\n            if (platformOrderId == orderId) {\n                this.mPaymentOrderList.splice(i, 1);\n                break;\n            }\n        }\n        ty.Storage.setItem(ty.Storage.Key_Payment_Notify_Order_List, this.mPaymentOrderList.join('|'));\n        this.notifyPaymentOnce();\n    },\n});\n\ntywx.TYPay = new metaclass();\n\n// tywx.TYPay.init();"]}