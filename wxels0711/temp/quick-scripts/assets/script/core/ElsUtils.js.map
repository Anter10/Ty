{"version":3,"sources":["ElsUtils.js"],"names":["crypto","require","ZhubaoMap","Map","ElsUtils","array","times","ret","t","i","length","ran_idx","parseInt","Math","random","params","tmp_canvas","wx","createCanvas","height","size","width","self","tmp_context","getContext","bg_img","createImage","bg_x","bg_y","bg_w","bg_h","src","bg","onload","drawImage","h_w","h_h","user_head_img","user_heard_url","h_x","h_y","save","translate","rotate","PI","restore","head_img","heard_url","str_content","wisper_ming","f_x","f_y","fillStyle","font","fillText","wisper_an","toTempFilePath","x","y","destWidth","destHeight","fileType","quality","success","res","saveImage2PhoneByUrl","tempFilePath","fail","console","log","url","cb_success","cb_fail","saveImg2Phone","saveImageToPhotosAlbum","filePath","getSetting","authSetting","authorize","scope","openSetting","complete","key","cc","sys","localStorage","removeItem","tywx","isInWXChat","removeUserCloudStorage","keyList","msg","value","only_local","setItem","setUserCloudStorage","KVDataList","default_value","v","getItem","tag","result","success_cb","fail_cb","shareTickets","call_succ","call_fail","ff","getShareInfo","shareTicket","iv","encryptedData","resultStr","decrypt","UserInfo","wxgame_session_key","resultObj","JSON","parse","id","openGId","t0","loadItem","tc","Date","getTime","saveItem","e","crypted","decoded","Buffer","decipher","createDecipheriv","setAutoPadding","update","final","err","_itemId","_i","substr","pf_tag","_pf","map","has","get","fill_value","module","exports"],"mappings":"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","file":"ElsUtils.js","sourceRoot":"../../../../../assets/script/core","sourcesContent":["import els from \"../core/els.js\";\nvar crypto = require('crypto');\nconst ZhubaoMap = new Map([[112,0],[113,1],[114,2]]);\nclass ElsUtils{\n    constructor(){}\n\n    /**\n     * * 洗牌算法\n     * @param {Array} array 需要洗的数组\n     * @param {int} times 洗牌次数，默认洗牌2次 \n     * @author lu ning\n     * @date 11:31 2018/7/5\n     * @return {Array} 返回值描述\n     */\n    static shuffle(array, times = 2){\n        let ret = array;\n        for(let t = 0; t < times; t++){\n            for(let i = 0; i < ret.length - 1; i++){\n                let ran_idx = parseInt(Math.random() * (ret.length - 1));\n                [ret[i],ret[ran_idx]] = [ret[ran_idx],ret[i]];\n            }\n        }\n        return ret;\n    }\n\n    /**\n     * * 函数描述\n     * @param params Object\n     *        params.wisper_ming string 悄悄话 明文\n     *        params.wisper_an string 悄悄话 暗文\n     *        params.heard_url string 玩家头像\n     *        params.size cc.size 尺寸\n     *        params.bg string 背景图片\n     *        params.success function 成功回调\n     *        params.fail function 失败回调\n     * 流程:\n     * 1. 创建离屏canvas\n     * 2. 绘制背景\n     * 3. 绘制头像\n     * 4. 绘制文本\n     * 5. 截屏保存到本地\n     * 6. 将本地图片保存到相册\n     * @author lu ning\n     * @date 11:31 2018/7/5\n     * @return {Object} 返回值描述\n     */\n    static createAndSaveImg2WXAlbum(params){\n        let tmp_canvas = wx.createCanvas();\n        tmp_canvas.height = params.size.height;\n        tmp_canvas.width = params.size.width;\n        let self = this;\n\n        let tmp_context = tmp_canvas.getContext('2d');\n        //! 绘制背景\n        let bg_img = wx.createImage();\n        let bg_x = 0;\n        let bg_y = 0;\n        let bg_w = params.size.width;\n        let bg_h = params.size.height;\n\n        bg_img.src = params.bg;\n        bg_img.onload = ()=>{\n            tmp_context.drawImage(bg_img,bg_x,bg_y,bg_w,bg_h);\n            //! 绘制head\n            var h_w = 90;\n            var h_h = 90;\n            var user_head_img = wx.createImage();\n            user_head_img.src = params.user_heard_url;\n            user_head_img.onload = function() {\n              var h_x = 240;\n              var h_y = 260;\n              tmp_context.save();\n              tmp_context.translate(70, -50);\n              tmp_context.rotate(13 * Math.PI / 180);\n              tmp_context.drawImage(user_head_img, h_x, h_y, h_w, h_h);\n              tmp_context.restore();\n              var head_img = wx.createImage();\n              head_img.src = params.heard_url;\n              head_img.onload = function() {\n                var h_x = 129;\n                var h_y = 229;\n                tmp_context.drawImage(head_img, h_x, h_y, h_w, h_h);\n\n                //! 绘制悄悄话\n                let str_content = params.wisper_ming;\n                let f_x = 190;\n                let f_y = 542;\n                // tmp_context.save();\n                // tmp_context.rotate(7 * Math.PI / 180);\n\n                tmp_context.fillStyle=\"#461500\";\n                tmp_context.font = \"50px Arial\";\n                 tmp_context.fillText(str_content, f_x + 15 , f_y);\n                str_content = params.wisper_an;\n                f_y = 680;\n                tmp_context.font = \"50px Arial\";\n                tmp_context.fillText(str_content, f_x + 70 , f_y);\n                // tmp_context.restore();\n                //! 截屏,保存到本地\n                tmp_canvas.toTempFilePath({\n                    x: 0,\n                    y: 0,\n                    width: params.size.width,\n                    height: params.size.height,\n                    destWidth: params.size.width,\n                    destHeight: params.size.height,\n                    fileType: 'png',\n                    quality: 1.0,\n                    success: (res)=>{\n                        self.saveImage2PhoneByUrl(res.tempFilePath,params.success,params.fail);\n                    },\n                    fail: (res)=>{\n                        console.log(`createWisperShareImgWithContent failed ${res} .`);\n                        if(params.fail){\n                            params.fail();\n                        }\n                    },\n                });\n            };\n        };\n            };\n    }\n\n    static saveImage2PhoneByUrl(url, cb_success, cb_fail){\n        let saveImg2Phone = ()=>{\n            if(!wx.saveImageToPhotosAlbum){\n                cb_fail();\n                return;\n            }\n\n            wx.saveImageToPhotosAlbum({\n                filePath: url,\n                success: (res)=>{\n                    cb_success();\n                },\n                fail: (res)=>{\n                    cb_fail();\n                }\n            });\n        };\n        wx.getSetting({\n            success: (res)=>{\n                if (!res.authSetting['scope.writePhotosAlbum']) {\n                    wx.authorize({\n                        scope : \"scope.writePhotosAlbum\",\n                        success : function () {\n                            saveImg2Phone();\n                        },\n                        fail:function () {\n                            // wx.showModal({\n                            //     title: '提示',\n                            //     content: '这是一个模态弹窗',\n                            //     success: function(res) {\n                            //       if (res.confirm) {\n                            //         console.log('用户点击确定');\n                            //       } else if (res.cancel) {\n                            //         console.log('用户点击取消');\n                            //       }\n                            //     }\n                            //   });\n                            // let button = wx.createOpenSettingButton({\n                            //     type: 'text',\n                            //     text: '打开设置页面',\n                            //     style: {\n                            //         left: 10,\n                            //         top: 76,\n                            //         width: 200,\n                            //         height: 40,\n                            //         lineHeight: 40,\n                            //         backgroundColor: '#ff0000',\n                            //         color: '#ffffff',\n                            //         textAlign: 'center',\n                            //         fontSize: 16,\n                            //         borderRadius: 4\n                            //     }\n                            // });\n                            // button.onTap((res)=>{\n                            //     button.destroy();\n                            //     console.log('button click callback ',res);\n                            // });\n                            \n                            if(wx.openSetting){\n                                wx.openSetting({\n                                    success: (res)=>{\n                                        console.log('success',res);\n                                        if(res.authSetting['scope.writePhotosAlbum']){\n                                            saveImg2Phone();\n                                        }\n                                        else{\n                                            cb_fail();\n                                        }\n                                    },\n                                    fail: (res)=>{\n                                        console.log('fail',res);\n                                        cb_fail();\n                                    }\n                                });\n                            }\n                            else{\n                                cb_fail();\n                            }\n                        },\n                        complete:function () {\n                        }\n                    });\n                }\n                else{\n                    saveImg2Phone();\n                }\n            },\n            fail: (res)=>{\n                cb_fail();\n            }\n        });\n    }\n\n    static delItem(key) {\n        cc.sys.localStorage.removeItem(key);\n        if (!tywx.isInWXChat)\n            return;\n        wx.removeUserCloudStorage({\n            keyList: [key],\n            success: (msg) => { console.log('removeObjectCloud  ' + key + ' succeeds', msg); },\n            fail: (msg) => { console.log('removeObjectCloud  ' + key + ' fails', msg); },\n        });\n    }\n\n    static saveItem (key, value, only_local) {\n        value = value + '';\n        cc.sys.localStorage.setItem(key, value);\n        if (!tywx.isInWXChat)\n            return;\n        if (!only_local) {\n            //FIXED: 做版本检测，版本低的会有黑屏\n            if(wx.setUserCloudStorage){\n                wx.setUserCloudStorage({\n                    KVDataList: [{ key: key, value: value }],\n                    success: (msg) => { console.log('saveObjectToCloud  ' + key + ' succeeds', msg); },\n                    fail: (msg) => { console.log('saveObjectToCloud  ' + key + ' fails', msg); },\n                });\n            }\n        }\n    }\n\n    static loadItem (key, default_value) {\n        var v = cc.sys.localStorage.getItem(key);\n        // console.log(key, 'v'+v);\n        if (!v) {\n            cc.sys.localStorage.setItem(key, default_value);\n            return default_value;\n        }\n        return v;\n    }\n\n    static isCanShare2GroupByTicket(tag, result, success_cb, fail_cb) {\n        if (!result.shareTickets || !result.shareTickets[0]) return false;\n        let ret = false;\n        let call_succ = () => {\n            if (success_cb) success_cb();\n        };\n        let call_fail = () => {\n            if (fail_cb) fail_cb();\n        };\n        let ff = ElsUtils;\n\n        wx.getShareInfo({\n            shareTicket: result.shareTickets[0],\n            success: (res) => {\n                console.log('isCanShare2GroupByTicket==>', res);\n                try {\n                    let iv = res.iv;\n                    let encryptedData = res.encryptedData;\n                    let resultStr = ff.decrypt(tywx.UserInfo.wxgame_session_key, iv, encryptedData);\n                    console.log('resultStr==>', resultStr);\n                    if (resultStr && resultStr !== 0) {\n                        let resultObj = JSON.parse(resultStr);\n                        let id = `${tag}_${resultObj.openGId}`;\n                        let t0 = parseInt(ff.loadItem(id, 0));\n                        let tc = new Date().getTime();\n                        console.log('isCanShare2GroupByTicket==>openGId', id, typeof id);\n                        if (tc - t0 >= 24 * 60 * 60 * 1000) {\n                            ret = true;\n                            ff.saveItem(id, tc, true);\n                            call_succ();\n                        } else {\n                            call_fail();\n                        }\n                    }else {\n                        call_fail();\n                    }\n\n                } catch (e) {\n                    console.log(\"share::\" , e);\n                    call_fail();\n                }\n            },\n            fail: () => {\n                call_fail();\n            }\n        });\n\n        return ret;\n    }\n\n    static decrypt(key, iv, crypted) {\n        var decoded = 0;\n        try {\n            crypted = new Buffer(crypted, 'base64');\n            iv = new Buffer(iv, 'base64');\n            key = new Buffer(key, 'base64');\n\n            var decipher = crypto.createDecipheriv('aes-128-cbc', key, iv);\n            decipher.setAutoPadding(true);\n\n            decoded = decipher.update(crypted, 'binary', 'utf8');\n            decoded += decipher.final('utf8');\n        } catch (err) {\n            console.log(\"fengbing\", \" catch error: \" + err);\n        }\n        return decoded;\n    }\n\n    /**\n     * 检查此道具是否是虚拟礼物\n     * @param  {[type]} _itemId [道具ID或商品ID]\n     * @return {[type]}         [YES or NO]\n     */\n    static checkGift(_itemId) {\n        let ret = false;\n        let _i = _itemId + \"\";\n        if (300 < parseInt(_i.substr(_i.length - 3, 3))) {\n            ret = true;\n        }\n        return ret;\n    }\n\n    static checkPF(_itemId){ // 检查是否是皮肤\n        let ret = false;\n        let _i = _itemId + \"\";\n        if (300 > parseInt(_i.substr(_i.length - 3, 3)) && parseInt(_i.substr(_i.length - 3, 3)) > 200) {\n            ret = true;\n        }\n        return ret;\n    }\n\n    static selectPF(_itemId) { // 检查是否选中此皮肤\n        let ret = false;\n        let _i = _itemId + \"\";\n        let pf_tag = parseInt(_i.substr(_i.length - 3, 3));\n        let _pf = parseInt(ElsUtils.loadItem(\"els_select_pifu\", 201));\n        if (_pf === pf_tag) {\n            ret = true;\n        }\n        return ret;\n    }\n\n    static savePF(_itemId) { // 保存皮肤\n        let _i = _itemId + \"\";\n        let pf_tag = parseInt(_i.substr(_i.length - 3, 3));\n        ElsUtils.saveItem(\"els_select_pifu\", pf_tag, true);\n    }\n\n    static formatPropServerId2LocalId(id){\n        let map = new Map([[1018,0],[1017,1],[1019,2],[1014,3]]);\n        return map.has(id) ? map.get(id) : -1;\n    }\n\n    static formatPropLocalId2ServerId(id){\n        id += 1;\n        let map = new Map([[0,1018],[1,1017],[2,1019],[3,1014]]);\n        return map.has(id) ? map.get(id) : -1;\n    }\n\n    static loginServerId2String(id){\n        let map = new Map([[7,'第七天'],[1,'第一天'],[2,'第二天'],[3,'第三天'],[4,'第四天'],[5,'第五天'],[6,'第六天']]);\n        id += 1;\n        return map.has(id) ? map.get(id) : `错误的id${id}`;\n    }\n    /**\n     * \n     * @param {Number} fill_value \n     */\n    static isZhubao(fill_value){\n        return ZhubaoMap.has(fill_value);\n    }\n}\n\nmodule.exports = ElsUtils;"]}