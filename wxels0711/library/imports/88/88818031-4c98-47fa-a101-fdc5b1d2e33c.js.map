{"version":3,"sources":["../../../../../assets/script/CommonFrame/assets/script/CommonFrame/OpenDataContextUtil.js"],"names":["tywx","OpenDataContextUtil","methodIndex","methodCallDic","isOnTimer","initCheckTimer","cb","checkOpenDataContextStat","Timer","setTimer","cc","director","macro","REPEAT_FOREVER","key","openDataContext","wx","getOpenDataContext","sharedCanvas","canvas","context","getContext","LOGD","JSON","stringify","NotificationCenter","trigger","EventType","GET_OPEN_DATA_RESULT_SUCCESS","GET_OPEN_DATA_RESULT_FAIL","Date","valueOf","GET_OPEN_DATA_RESULT_TIMEOUT","e","getUserInfo","successCallBack","failCallBack","methodName","methodId","window","postMessage","method","data","method_id","time","success_callback","fail_callback","updateRankData","kv","item","toString","push","kvDataList","getFriendCloudStorage","types","getFriendRankData","keyList","baseList","indexOf","getGroupRankData","shareTicket"],"mappings":"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","file":"OpenDataContextUtil.js","sourceRoot":"../../../../../assets/script/CommonFrame","sourcesContent":["/**\n * Created by xiaochuntian on 2018/5/28.\n */\n\n\ntywx.OpenDataContextUtil = {\n    methodIndex: 0,\n    methodCallDic: {},\n    isOnTimer: false,\n    /**\n     * 开启检查定时器\n     */\n    initCheckTimer: function() {\n        if(this.isOnTimer) return;\n        this.isOnTimer = true;\n        var cb = function() {\n            tywx.OpenDataContextUtil.checkOpenDataContextStat()\n        };\n        tywx.Timer.setTimer(cc.director, cb, 1/10, cc.macro.REPEAT_FOREVER, 0);\n    },\n\n    /**\n     * 根据请求发出的列表,检查子域数据获取情况,结果分为成功|失败|超时三种,进行回调和事件通知\n     */\n    checkOpenDataContextStat: function() {\n        for(var key in this.methodCallDic) {\n            try {\n                var openDataContext = wx.getOpenDataContext();\n                var sharedCanvas = openDataContext.canvas;\n                var context = sharedCanvas.getContext(\"2d\");\n                tywx.LOGD(\"开始检查:\" + key, \"abcd\");\n                if(context[key]) {\n                    if(context[key][\"status\"] == true) {\n                        //成功,有回调调回调,同时trigger事件出去\n                        tywx.LOGD(\"success_callback:\" + key, JSON.stringify(context[key]));\n                        this.methodCallDic[key][\"success_callback\"] && this.methodCallDic[key][\"success_callback\"](context[key][\"data\"]);\n                        tywx.NotificationCenter.trigger(tywx.EventType.GET_OPEN_DATA_RESULT_SUCCESS, [key, context[key][\"data\"]]);\n                    } else {\n                        //失败,\n                        tywx.LOGD(\"success_callback:\" + key, JSON.stringify(context[key]));\n                        this.methodCallDic[key][\"fail_callback\"] && this.methodCallDic[key][\"fail_callback\"](context[key][\"data\"]);\n                        tywx.NotificationCenter.trigger(tywx.EventType.GET_OPEN_DATA_RESULT_FAIL, [key, context[key][\"data\"]]);\n                    }\n                    delete context[key];\n                    delete this.methodCallDic[key];\n                } else {\n                    if((new Date()).valueOf() - this.methodCallDic[key][\"time\"] > 500) {//两秒都没返回\n                        this.methodCallDic[key][\"fail_callback\"] && this.methodCallDic[key][\"fail_callback\"]();\n                        //超时\n                        tywx.NotificationCenter.trigger(tywx.EventType.GET_OPEN_DATA_RESULT_TIMEOUT, [key]);\n                        delete context[key];\n                        delete this.methodCallDic[key];\n                    }\n                }\n            } catch(e) {\n                //失败\n                this.methodCallDic[key][\"fail_callback\"] && this.methodCallDic[key][\"fail_callback\"]();\n                delete this.methodCallDic[key];\n            }\n        }\n    },\n\n    /**\n     * 向子域请求获取用户信息\n     * @param successCallBack\n     * @param failCallBack\n     * @returns {string}\n     */\n    getUserInfo: function(successCallBack, failCallBack) {\n        var methodName = \"getUserInfo\";\n        var methodId = methodName + this.methodIndex;\n\n        if(!window.wx){\n           //防止在浏览器中报错\n           return;\n        }  \n\n        var openDataContext = wx.getOpenDataContext();\n        openDataContext.postMessage({\n            method : methodName,\n            data : {\n                method_id: methodId\n            },\n        });\n        this.methodIndex++;\n        this.methodCallDic[methodId] = {\n            time: (new Date()).valueOf(),\n            success_callback: successCallBack,\n            fail_callback: failCallBack\n        };\n        this.initCheckTimer();\n        return methodId;\n    },\n\n\n    /**\n     * 更新上报信息,更新内容由调用者传入,格式为{key1:value1,key2:value2}\n     * @param data\n     * @returns {string}\n     */\n    updateRankData: function(data) {\n        var methodName = \"updateRankData\";\n        var methodId = methodName + this.methodIndex;\n        var kv = [];\n        for(var key in data) {\n            var item = {\n                \"key\": key.toString(),\n                \"value\": data[key].toString()\n            };\n            kv.push(item)\n        }\n        var openDataContext = wx.getOpenDataContext();\n        openDataContext.postMessage({\n            method : methodName,\n            data : {\n                method_id: methodId,\n                kvDataList : kv\n            }\n        });\n        this.methodIndex++;\n        return methodId;\n    },\n\n    /**\n     * 向子域请求获取排行榜信息\n     * @param type : ELS_PKSTAR ELS_CURRENT_STAGE2\n     * @param successCallBack\n     * @param failCallBack\n     * @returns {string}\n     */\n    getFriendCloudStorage: function(types, successCallBack, failCallBack) {\n        var methodName = \"getFriendCloudStorage\";\n        var methodId = methodName + this.methodIndex;\n\n        if(!window.wx){\n           //防止在浏览器中报错\n           return;\n        }\n\n        var openDataContext = wx.getOpenDataContext();\n        openDataContext.postMessage({\n            types: types,\n            method : methodName,\n            data : {\n                method_id: methodId\n            }\n        });\n        this.methodIndex++;\n        this.methodCallDic[methodId] = {\n            time: (new Date()).valueOf(),\n            success_callback: successCallBack,\n            fail_callback: failCallBack\n        };\n        this.initCheckTimer();\n        return methodId;\n    },\n\n    /**\n     * 向子域请求好友排行榜信息\n     * @param keyList\n     * @param successCallBack\n     * @param failCallBack\n     * @returns {string}\n     */\n    getFriendRankData: function(keyList, successCallBack, failCallBack) {\n        var methodName = \"getFriendRankData\";\n        var methodId = methodName + this.methodIndex;\n        var baseList = [\"avatarUrl\", \"nickName\"];\n        for(var key in baseList) {\n            if(keyList.indexOf(baseList[key]) < 0) {\n                keyList.push(baseList[key].toString());\n            }\n        }\n        var openDataContext = wx.getOpenDataContext();\n        openDataContext.postMessage({\n            method : 'getFriendRankData',\n            data : {\n                method_id: methodId,\n                keyList : keyList\n            }\n        });\n        this.methodCallDic[methodId] = {\n            time: (new Date()).valueOf(),\n            success_callback: successCallBack,\n            fail_callback: failCallBack\n        };\n        return methodId;\n    },\n\n    /**\n     * 向子域请求获取群排行榜信息\n     * @param keyList\n     * @param shareTicket\n     * @param successCallBack\n     * @param failCallBack\n     * @returns {string}\n     */\n    getGroupRankData: function(keyList, shareTicket,  successCallBack, failCallBack) {\n        var methodName = \"getFriendRankData\";\n        var methodId = methodName + this.methodIndex;\n        var baseList = [\"avatarUrl\", \"nickName\"];\n        for(var key in baseList) {\n            if(keyList.indexOf(baseList[key]) < 0) {\n                keyList.push(baseList[key].toString());\n            }\n        }\n        var openDataContext = wx.getOpenDataContext();\n        openDataContext.postMessage({\n            method : 'getGroupRankData',\n            data : {\n                method_id: methodId,\n                shareTicket: shareTicket,\n                keyList : keyList\n            }\n        });\n        this.methodCallDic[methodId] = {\n            time: (new Date()).valueOf(),\n            success_callback: successCallBack,\n            fail_callback: failCallBack\n        };\n        return methodId;\n    },\n};\n"]}